<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CoinPay Game</title>

<style>
body{
    font-family: Arial, sans-serif;
    background:#f2f2f2;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
}

.container{
    background:#fff;
    padding:25px;
    width:360px;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,.1);
    text-align:center;
    position:relative;
}

/* Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
#notifBtn {
    position: absolute;
    top:10px;
    left:10px;
    width:40px;
    height:40px;
    border-radius:50%;
    border:none;
    background:#e60000;
    color:#fff;
    font-size:18px;
    cursor:pointer;
    display:flex;
    justify-content:center;
    align-items:center;
}

/* ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ù‚Ù… */
.badge {
    position:absolute;
    top:-5px;
    right:-5px;
    background:yellow;
    color:black;
    border-radius:50%;
    padding:2px 6px;
    font-size:12px;
    font-weight:bold;
    display:none;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
#notifBox {
    display:none; /* ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· ÙÙ‚Ø· */
    position:absolute;
    top:50px;
    left:10px;
    width:300px;
    max-height:200px;
    overflow-y:auto;
    background:#fff;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,.2);
    padding:10px;
    z-index:10;
    text-align:right;
}

.notif-item{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    margin-bottom:5px;
    background:#f9f9f9;
    padding:4px 6px;
    border-radius:5px;
    gap:8px;
}

.delete-btn{
    background:none;
    border:none;
    cursor:pointer;
    font-size:14px;
    width:16px;
    height:16px;
    line-height:16px;
    padding:0;
    text-align:center;
    color:red;
}

/* Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
.notif-item span{
    flex-grow:1;
    text-align:right;
}

h2{margin-bottom:10px}
#balance{font-size:18px;margin-bottom:15px}

input{
    width:100%;
    padding:10px;
    margin:6px 0;
    border-radius:6px;
    border:1px solid #ccc;
}

button{
    width:100%;
    padding:10px;
    margin-top:8px;
    border:none;
    border-radius:6px;
    background:#e60000;
    color:#fff;
    font-size:15px;
    cursor:pointer;
}

button:hover{background:#ff0000}

.small-btn{
    background:#222;
    margin-top:6px;
}
.small-btn:hover{background:rgb(255, 0, 0)}

.error{
    color:red;
    font-size:14px;
    margin-top:6px
}

#depositBox{
    display:none;
    border:1px solid #ccc;
    padding:10px;
    border-radius:8px;
    margin-top:8px;
}

/* ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª */
table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    font-size:14px;
}

th,td{
    padding:10px;
    border-bottom:1px solid #ddd;
    text-align:center;
}

th{
    background:#222;
    color:#fff;
}

.arrow-up {
    color:green;
    font-size:18px;
}

.arrow-down {
    color:red;
    font-size:18px;
}
</style>
</head>

<body>
<div class="container">

<!-- Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<button id="notifBtn">
    ğŸ””<span id="notifCount" class="badge">0</span>
</button>

<!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
<div id="notifBox">
    <ul id="notifList"></ul>
</div>

<h2 id="welcome"></h2>
<div id="balance"></div>
<hr>

<h3>ØªØ­ÙˆÙŠÙ„ Ø¹Ù…Ù„Ø§Øª</h3>
<input id="toUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
<input id="amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
<button id="sendBtn">ØªØ­ÙˆÙŠÙ„</button>
<p class="error" id="msg"></p>

<button id="depositBtn">Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹</button>
<div id="depositBox">
    <input id="depositAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
    <button id="sendDepositBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
    <p class="error" id="depositMsg"></p>
</div>

<hr>

<button class="small-btn" id="editBtn">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
<button class="small-btn" id="historyBtn">Ø³Ø¬Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª</button>
<button id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>

<table id="historyTable" style="display:none">
<thead>
<tr>
    <th>Ù…Ù†</th>
    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
    <th>Ø§Ù„ØªÙˆØ¬ÙŠÙ‡</th>
</tr>
</thead>
<tbody id="historyBody"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get, child, update, push, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB9mzy7VtnJV28qawDMYYEfTr8guf9Z5hQ",
  authDomain: "coinpay-3f182.firebaseapp.com",
  databaseURL: "https://coinpay-3f182-default-rtdb.firebaseio.com",
  projectId: "coinpay-3f182",
  storageBucket: "coinpay-3f182.firebasestorage.app",
  messagingSenderId: "9785521136",
  appId: "1:9785521136:web:117b57499cb35ba5db6335"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const welcome = document.getElementById("welcome");
const balanceEl = document.getElementById("balance");
const msg = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");
const toUser = document.getElementById("toUser");
const amount = document.getElementById("amount");
const editBtn = document.getElementById("editBtn");
const historyBtn = document.getElementById("historyBtn");
const logoutBtn = document.getElementById("logoutBtn");
const historyTable = document.getElementById("historyTable");
const historyBody = document.getElementById("historyBody");

const depositBtn = document.getElementById("depositBtn");
const depositBox = document.getElementById("depositBox");
const depositAmount = document.getElementById("depositAmount");
const sendDepositBtn = document.getElementById("sendDepositBtn");
const depositMsg = document.getElementById("depositMsg");

const notifBtn = document.getElementById("notifBtn");
const notifBox = document.getElementById("notifBox");
const notifList = document.getElementById("notifList");
const notifCount = document.getElementById("notifCount");

let currentUser = localStorage.getItem("currentUser");
if(!currentUser){ alert("Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„"); location.href="index.html"; }

/* ================= ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ================= */
function loadUserData(){
    get(child(ref(db), 'users/'+currentUser)).then(snapshot=>{
        if(!snapshot.exists()){ localStorage.removeItem("currentUser"); location.href="index.html"; return; }
        const data = snapshot.val();
        if(data.balance===undefined) data.balance=0;
        welcome.textContent = "Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ "+currentUser;
        balanceEl.textContent = "Ø±ØµÙŠØ¯Ùƒ: "+data.balance.toLocaleString()+" Ø¹Ù…Ù„Ø©";
    });
}
loadUserData();

/* ================= Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ================= */
depositBtn.onclick = ()=>{ depositBox.style.display = depositBox.style.display==="block"?"none":"block"; }

sendDepositBtn.onclick = ()=>{
    depositMsg.textContent="";
    const amt = Number(depositAmount.value);
    if(isNaN(amt) || amt<=0){ depositMsg.textContent="Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­"; return; }

    push(ref(db,'depositRequests'),{
        user: currentUser,
        amount: amt,
        status:"pending",
        date:new Date().toLocaleString()
    }).then(()=>{
        depositMsg.textContent="ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…";
        depositAmount.value="";
    });
};

/* ================= Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ================= */
let notifications = [];
let unseenCount = 0;

function loadNotificationsCount(){
    get(child(ref(db),'notifications/'+currentUser)).then(snapshot=>{
        notifications = [];
        if(snapshot.exists()){
            snapshot.forEach(childSnap=>{
                notifications.push({key:childSnap.key, message:childSnap.val().message});
            });
            unseenCount = notifications.length;
        } else unseenCount = 0;
        updateBadge();
    });
}

function updateBadge(){
    notifCount.textContent = unseenCount;
    notifCount.style.display = unseenCount>0?"block":"none";
}

notifBtn.onclick = (e)=>{
    e.stopPropagation();
    notifBox.style.display = notifBox.style.display==="block"?"none":"block";

    // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø´Ø¹Ø§Ø± Ø§Ù„Ø§Ø®ÙŠØ± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
    notifList.innerHTML="";
    if(notifications.length>0){
        const lastNotif = notifications[notifications.length-1];
        const li = document.createElement("li");
        li.classList.add("notif-item");
        li.innerHTML = `<button class="delete-btn">ğŸ—‘</button><span>${lastNotif.message}</span>`;
        const delBtn = li.querySelector(".delete-btn");
        delBtn.onclick = ()=>{
            remove(ref(db,'notifications/'+currentUser+'/'+lastNotif.key));
            li.remove();
            unseenCount=0;
            updateBadge();
        };
        notifList.appendChild(li);
        unseenCount=0;
        updateBadge();
    }else{
        notifList.innerHTML="<li style='color:#555;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</li>";
    }
};

window.addEventListener("load", loadNotificationsCount);
document.addEventListener("click",()=>{ notifBox.style.display="none"; });

/* ================= Ø¥Ø±Ø³Ø§Ù„ ØªØ­ÙˆÙŠÙ„ ================= */
sendBtn.onclick = ()=>{
    msg.textContent = "";
    const to = toUser.value.trim();
    const amt = Number(amount.value);
    if(!to || isNaN(amt) || amt<=0){ msg.textContent="Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©"; return; }
    if(to===currentUser){ msg.textContent="Ù…ÙŠÙ†ÙØ¹Ø´ ØªØ­ÙˆÙ„ Ù„Ù†ÙØ³Ùƒ"; return; }

    get(child(ref(db),'users/'+to)).then(snapshot=>{
        if(!snapshot.exists()){ msg.textContent="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"; return; }
        const recipient = snapshot.val();
        get(child(ref(db),'users/'+currentUser)).then(snap=>{
            const sender = snap.val();
            if(sender.balance<amt){ msg.textContent="Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ"; return; }

            sender.balance-=amt;
            recipient.balance+=amt;

            const now = new Date().toLocaleString();
            recipient.history??=[];
            recipient.history.push({from:currentUser,amount:amt,date:now});
            sender.history??=[];
            sender.history.push({from:currentUser,amount:-amt,date:now});

            let updates={};
            updates['users/'+currentUser]=sender;
            updates['users/'+to]=recipient;
            update(ref(db),updates).then(()=>{ loadUserData(); toUser.value=""; amount.value=""; alert("ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…"); });
        });
    });
};

/* ================= Ø³Ø¬Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª ================= */
historyBtn.onclick = ()=>{
    get(child(ref(db),'users/'+currentUser+'/history')).then(snapshot=>{
        historyBody.innerHTML="";
        const h = snapshot.val()||[];
        if(h.length===0){ historyBody.innerHTML="<tr><td colspan='4'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>"; }
        else{
            h.forEach(x=>{
                let arrow = "";
                if(x.amount > 0) arrow = `<span class="arrow-down">â¬‡</span>`;  // ØªØ­ÙˆÙŠÙ„ Ù…Ù† Ø·Ø±ÙÙƒ
                if(x.amount < 0) arrow = `<span class="arrow-up">â¬†</span>`;  // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„ÙŠÙƒ
                historyBody.innerHTML+=`
                <tr>
                    <td>${x.from}</td>
                    <td>${Math.abs(x.amount).toLocaleString()}</td>
                    <td>${x.date}</td>
                    <td>${arrow}</td>
                </tr>`;
            });
        }
        historyTable.style.display="table";
    });
};

/* ================= ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ ================= */
editBtn.onclick = ()=>{
    const newUser = prompt("ÙŠÙˆØ²Ø± Ø¬Ø¯ÙŠØ¯ (Ø³ÙŠØ¨ ÙØ§Ø¶ÙŠ Ù„Ùˆ Ù„Ø§)");
    const newPass = prompt("Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯ (Ø³ÙŠØ¨ ÙØ§Ø¶ÙŠ Ù„Ùˆ Ù„Ø§)");
    get(child(ref(db),'users/'+currentUser)).then(snapshot=>{
        if(!snapshot.exists()) return;
        let userData = snapshot.val();
        let updates={};
        if(newUser){ updates['users/'+newUser]=userData; updates['users/'+currentUser]=null; localStorage.setItem("currentUser",newUser); currentUser=newUser; }
        if(newPass) userData.password=newPass;
        updates['users/'+currentUser]=userData;
        update(ref(db),updates).then(()=>{ alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…"); loadUserData(); });
    });
};

/* ================= ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ================= */
logoutBtn.onclick = ()=>{ localStorage.removeItem("currentUser"); location.href="index.html"; };
</script>
</body>
</html>